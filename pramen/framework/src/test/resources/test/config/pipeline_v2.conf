
# This variable is expected to be set up by the test suite
#base.path = "/tmp"

pramen.metastore {
  tables = [
    {
      name = "table1_sync"
      description = "Table 1 description"
      format = "parquet"
      path = ${base.path}/table1
      records.per.partition = 1000000

      information.date.column = "INFORMATION_DATE"
      information.date.format = "yyyy-MM-dd"
      information.date.expression = "@runDate - 1"
      information.date.start = "2017-01-31"
    },
    {
      name = "table2_sync"
      description = "Table 2 description"
      format = "delta"
      path = ${base.path}/table2
    },
    {
      name = "table_out"
      description = "Output table"
      format = "delta"
      path = ${base.path}/table_out
    }
  ]
}

pramen.pipeline {
  name = "pipeline_v2"
}

pramen.operations = [
  {
    # Mandatory
    name = "op1"
    type = "ingestion" # or "transformation" or "sink"
    schedule.type = "daily"

    source = "myjdbc"

    expected.delay.days = 5

    # Determines information date by the run date
    expected.delay.days = 1
    info.date.expr = "beginOfMonth(@runDate)"
    processing.timestamp.column = "SYNC_TIMESTAMP"

    tables = [
      {
        input.db.table = table1_db
        output.metastore.table = table1_sync
        transformations = [
          {col = "A", expr = "cast(A as decimal(15,5))"}
        ],
        filters = [
          "A > 2.0"
        ]
      },
      {
        input.sql = "SELECT * FROM table2_db WHERE information_date = date'@infoDate'"
        output.metastore.table = table2_sync
      }
    ]
  },
  {
    name = "op2"
    type = "transformation"
    class = "some.class"
    schedule.type = "daily"

    output.table = "table_out"
    track.days = 3

    dependencies = [
      {
        tables = [table1_sync, table2_sync]
        date.from = "@infoDate - 1"
      }
    ]

    transformations = [
      {col = "B", expr = "cast(B as double)"}
    ]

    filters = [
      "B > 2.0"
    ]
  }
]
